{% extends "base.html" %}

{% set active_page = 'dashboard' %}

{% block title %}Dashboard - AI Insight{% endblock %}

{% block content %}
<div class="breadcrumb">Overview / Dashboard</div>
<h1>System Overview</h1>
<p style="margin-bottom: 2.5rem; color: var(--text-muted);">Monitor your hotel image detection models and analysis
    history.</p>

<!-- Top Stats Cards -->
<div class="dashboard-stats" style="margin-bottom: 3rem;">
    <div class="card stat-box">
        <div class="stat-label">Total Predictions</div>
        <div class="stat-number">{{ total_predictions }}</div>
        <div class="stat-change change-up">Live Inference Count</div>
    </div>
    <div class="card stat-box">
        <div class="stat-label">Training Jobs</div>
        <div class="stat-number">{{ total_training }}</div>
        <div class="stat-change">Configured Sessions</div>
    </div>
    <div class="card stat-box">
        <div class="stat-label">AI Health</div>
        <div class="stat-number">Stable</div>
        <div class="stat-change change-up">All API Endpoints Online</div>
    </div>
    <div class="card stat-box">
        <div class="stat-label">Last Activity</div>
        <div class="stat-number" style="font-size: 1.25rem;">
            {% if recent_predictions %}
            {{ recent_predictions[0].created_at.strftime('%H:%M') }}
            {% else %}
            N/A
            {% endif %}
        </div>
        <div class="stat-change">Latest Inference</div>
    </div>
</div>

<!-- Middle Section: Two Column Cards -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- Training History Card -->
    <div class="card">
        <h3 style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <span>üìä Training History</span>
            <a href="/train"
                style="font-size: 0.875rem; color: var(--primary); text-decoration: none; font-weight: 700;">View All
                ‚Üí</a>
        </h3>

        {% if recent_training %}
        <table>
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for job in recent_training[:5] %}
                <tr>
                    <td><strong>{{ job.model_name|upper }}</strong></td>
                    <td>
                        <span
                            style="color: {{ '#10b981' if job.status == 'completed' else ('#6366f1' if job.status == 'training' else '#f59e0b') }}; font-weight: 700; font-size: 0.875rem;">
                            {{ job.status|capitalize }}
                        </span>
                    </td>
                    <td style="font-size: 0.875rem; color: var(--text-muted);">{{ job.created_at.strftime('%b %d,
                        %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if recent_training|length > 5 %}
        <button class="dropdown-toggle" onclick="toggleDropdown('training-dropdown')">
            Show {{ recent_training|length - 5 }} More ‚ñº
        </button>
        <div id="training-dropdown" class="dropdown-content">
            <table style="margin-top: 1rem;">
                <tbody>
                    {% for job in recent_training[5:] %}
                    <tr>
                        <td><strong>{{ job.model_name|upper }}</strong></td>
                        <td>
                            <span
                                style="color: {{ '#10b981' if job.status == 'completed' else ('#6366f1' if job.status == 'training' else '#f59e0b') }}; font-weight: 700; font-size: 0.875rem;">
                                {{ job.status|capitalize }}
                            </span>
                        </td>
                        <td style="font-size: 0.875rem; color: var(--text-muted);">{{ job.created_at.strftime('%b %d,
                            %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% else %}
        <div style="text-align: center; padding: 3rem 1rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üöÄ</div>
            <p style="color: var(--text-muted); font-weight: 600; margin-bottom: 0.5rem;">No Training Jobs Yet</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Start your first training session</p>
            <a href="/train" class="btn" style="margin-top: 1.5rem; display: inline-flex;">
                <span style="margin-right: 0.5rem;">ü§ñ</span> Start Training
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Quick Actions Card -->
    <div class="card">
        <h3 style="margin-bottom: 1.5rem;">‚ö° Quick Actions</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/predict" class="btn" style="width: 100%; justify-content: center;">
                <span style="margin-right: 0.5rem;">üéØ</span> New Image Analysis
            </a>
            <a href="/train" class="btn btn-secondary" style="width: 100%; justify-content: center;">
                <span style="margin-right: 0.5rem;">üöÄ</span> Configure Training
            </a>
            <a href="/train/get/config" class="btn btn-secondary" style="width: 100%; justify-content: center;">
                <span style="margin-right: 0.5rem;">‚öôÔ∏è</span> View Configuration
            </a>
        </div>

        <div
            style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1)); border-radius: 0.75rem; border: 2px solid var(--border-color);">
            <h4
                style="font-size: 0.875rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 1rem;">
                System Status</h4>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="font-size: 0.875rem; color: var(--text-muted);">API Status</span>
                <span style="font-size: 0.875rem; font-weight: 700; color: var(--success);">‚óè Online</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="font-size: 0.875rem; color: var(--text-muted);">Model Ready</span>
                <span style="font-size: 0.875rem; font-weight: 700; color: var(--success);">‚óè Yes</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.875rem; color: var(--text-muted);">Database</span>
                <span style="font-size: 0.875rem; font-weight: 700; color: var(--success);">‚óè Connected</span>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Section: Analysis History Full Width Card -->
<div class="card">
    <h3 style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <span>üñºÔ∏è Recent Analysis History</span>
        <a href="/predict"
            style="font-size: 0.875rem; color: var(--primary); text-decoration: none; font-weight: 700;">New Scan
            ‚Üí</a>
    </h3>

    {% if recent_predictions %}
    <!-- Show first 6 predictions as image gallery -->
    <div class="image-gallery">
        {% for pred in recent_predictions[:6] %}
        <div class="gallery-item">
            {% if pred.image_path %}
            <img src="/{{ pred.image_path }}" alt="Prediction Image"
                style="width: 100%; height: 180px; object-fit: cover; border-radius: 0.75rem 0.75rem 0 0;"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div
                style="width: 100%; height: 180px; background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%); display: none; align-items: center; justify-content: center; color: white; font-size: 3rem; border-radius: 0.75rem 0.75rem 0 0;">
                üñºÔ∏è
            </div>
            {% else %}
            <div
                style="width: 100%; height: 180px; background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; border-radius: 0.75rem 0.75rem 0 0;">
                üñºÔ∏è
            </div>
            {% endif %}
            <div class="gallery-item-info">
                <div class="gallery-item-title" title="{{ pred.filename }}">{{ pred.filename }}</div>
                <div class="gallery-item-meta">
                    <span class="gallery-item-label">{{ pred.prediction_text|upper }}</span>
                    <span class="gallery-item-confidence">{{ (pred.confidence * 100)|round(1) }}%</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if recent_predictions|length > 6 %}
    <button class="dropdown-toggle" onclick="toggleDropdown('predictions-dropdown')">
        Show {{ recent_predictions|length - 6 }} More ‚ñº
    </button>
    <div id="predictions-dropdown" class="dropdown-content">
        <div class="image-gallery" style="margin-top: 1rem;">
            {% for pred in recent_predictions[6:] %}
            <div class="gallery-item">
                {% if pred.image_path %}
                <img src="/{{ pred.image_path }}" alt="Prediction Image"
                    style="width: 100%; height: 180px; object-fit: cover; border-radius: 0.75rem 0.75rem 0 0;"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div
                    style="width: 100%; height: 180px; background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%); display: none; align-items: center; justify-content: center; color: white; font-size: 3rem; border-radius: 0.75rem 0.75rem 0 0;">
                    üñºÔ∏è
                </div>
                {% else %}
                <div
                    style="width: 100%; height: 180px; background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; border-radius: 0.75rem 0.75rem 0 0;">
                    üñºÔ∏è
                </div>
                {% endif %}
                <div class="gallery-item-info">
                    <div class="gallery-item-title" title="{{ pred.filename }}">{{ pred.filename }}</div>
                    <div class="gallery-item-meta">
                        <span class="gallery-item-label">{{ pred.prediction_text|upper }}</span>
                        <span class="gallery-item-confidence">{{ (pred.confidence * 100)|round(1) }}%</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div style="text-align: center; padding: 3rem 1rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üì∏</div>
        <p style="color: var(--text-muted); font-weight: 600; margin-bottom: 0.5rem;">No Analysis History Yet</p>
        <p style="color: var(--text-muted); font-size: 0.875rem;">Upload your first image to get started</p>
        <a href="/predict" class="btn" style="margin-top: 1.5rem; display: inline-flex;">
            <span style="margin-right: 0.5rem;">üéØ</span> Analyze Image
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}